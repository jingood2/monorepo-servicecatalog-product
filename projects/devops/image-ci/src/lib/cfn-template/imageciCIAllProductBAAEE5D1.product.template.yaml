Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: Git Repository Common Information
        Parameters:
          - SourceProviderType
          - RepoName
          - RepoBranch
      - Label:
          default: GitHub Information
        Parameters:
          - RepoOwner
          - GithubSecretTokenId
      - Label:
          default: Configuration for Codebuild
        Parameters:
          - ServiceName
          - sourceArtifact
          - ecsCluster
          - vpcId
          - albArn
Parameters:
  SourceProviderType:
    Type: String
    Default: GITHUB
    AllowedValues:
      - GITHUB
      - CODECOMMIT
      - JENKINS
      - BITBUCKET
      - S3
    Description: Source Provider Type
  RepoName:
    Type: String
    Description: Git Repository or S3 Bucket Name
  RepoOwner:
    Type: String
    Default: main
  RepoBranch:
    Type: String
    Default: main
  GithubSecretTokenId:
    Type: String
    Description: (Github Only Use)Secret Token Id for Github
  ServiceName:
    Type: String
    Default: demoapp
    Description: Service Name
  ContainerPort:
    Type: Number
    Default: "80"
    Description: Container Port
  S3BucketSourceArtifacts:
    Type: String
    Default: acme-servicecatalog-cicd-bucket
    Description: S3 Bucket Name for Source and Build Artifact
  PackagingType:
    Type: String
    Default: DOCKER
    AllowedValues:
      - MAVEN
      - GRADLE
      - NPM
      - PYTHON
      - DOCKER
    Description: Source Packaging Tool
  EnvType:
    Type: String
    Default: beanstalk
    AllowedValues:
      - ecs
      - fargate
      - eks
      - beanstalk
      - lambda
    Description: Source Packaging Tool
Conditions:
  IsGithubCondition:
    Fn::Equals:
      - GITHUB
      - Ref: SourceProviderType
  IsCodecommitCondition:
    Fn::Equals:
      - CODECOMMIT
      - Ref: SourceProviderType
  CDKMetadataAvailable:
    Fn::Or:
      - Fn::Or:
          - Fn::Equals:
              - Ref: AWS::Region
              - af-south-1
          - Fn::Equals:
              - Ref: AWS::Region
              - ap-east-1
          - Fn::Equals:
              - Ref: AWS::Region
              - ap-northeast-1
          - Fn::Equals:
              - Ref: AWS::Region
              - ap-northeast-2
          - Fn::Equals:
              - Ref: AWS::Region
              - ap-south-1
          - Fn::Equals:
              - Ref: AWS::Region
              - ap-southeast-1
          - Fn::Equals:
              - Ref: AWS::Region
              - ap-southeast-2
          - Fn::Equals:
              - Ref: AWS::Region
              - ca-central-1
          - Fn::Equals:
              - Ref: AWS::Region
              - cn-north-1
          - Fn::Equals:
              - Ref: AWS::Region
              - cn-northwest-1
      - Fn::Or:
          - Fn::Equals:
              - Ref: AWS::Region
              - eu-central-1
          - Fn::Equals:
              - Ref: AWS::Region
              - eu-north-1
          - Fn::Equals:
              - Ref: AWS::Region
              - eu-south-1
          - Fn::Equals:
              - Ref: AWS::Region
              - eu-west-1
          - Fn::Equals:
              - Ref: AWS::Region
              - eu-west-2
          - Fn::Equals:
              - Ref: AWS::Region
              - eu-west-3
          - Fn::Equals:
              - Ref: AWS::Region
              - me-south-1
          - Fn::Equals:
              - Ref: AWS::Region
              - sa-east-1
          - Fn::Equals:
              - Ref: AWS::Region
              - us-east-1
          - Fn::Equals:
              - Ref: AWS::Region
              - us-east-2
      - Fn::Or:
          - Fn::Equals:
              - Ref: AWS::Region
              - us-west-1
          - Fn::Equals:
              - Ref: AWS::Region
              - us-west-2
Resources:
  CIV2ECRRepositoryName631C35B1:
    Type: AWS::ECR::Repository
    Properties:
      RepositoryName:
        Ref: ServiceName
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
    Metadata:
      aws:cdk:path: image-ci/CIAllProduct/CIV2/ECRRepositoryName/Resource
  CIV2CIESBuildProjectRole91832A06:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: codebuild.amazonaws.com
        Version: 2012-10-17
    Metadata:
      aws:cdk:path: image-ci/CIAllProduct/CIV2/CIESBuildProject/Role/Resource
  CIV2CIESBuildProjectRoleDefaultPolicy35E296F6:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - logs:CreateLogGroup
              - logs:CreateLogStream
              - logs:PutLogEvents
            Effect: Allow
            Resource:
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - ":logs:"
                    - Ref: AWS::Region
                    - ":"
                    - Ref: AWS::AccountId
                    - :log-group:/aws/codebuild/
                    - Ref: CIV2CIESBuildProjectA5E45E83
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - ":logs:"
                    - Ref: AWS::Region
                    - ":"
                    - Ref: AWS::AccountId
                    - :log-group:/aws/codebuild/
                    - Ref: CIV2CIESBuildProjectA5E45E83
                    - :*
          - Action:
              - codebuild:CreateReportGroup
              - codebuild:CreateReport
              - codebuild:UpdateReport
              - codebuild:BatchPutTestCases
              - codebuild:BatchPutCodeCoverages
            Effect: Allow
            Resource:
              Fn::Join:
                - ""
                - - "arn:"
                  - Ref: AWS::Partition
                  - ":codebuild:"
                  - Ref: AWS::Region
                  - ":"
                  - Ref: AWS::AccountId
                  - :report-group/
                  - Ref: CIV2CIESBuildProjectA5E45E83
                  - -*
          - Action:
              - ecr:BatchCheckLayerAvailability
              - ecr:GetDownloadUrlForLayer
              - ecr:BatchGetImage
            Effect: Allow
            Resource:
              Fn::GetAtt:
                - CIV2ECRRepositoryName631C35B1
                - Arn
          - Action: ecr:GetAuthorizationToken
            Effect: Allow
            Resource: "*"
          - Action:
              - ecr:PutImage
              - ecr:InitiateLayerUpload
              - ecr:UploadLayerPart
              - ecr:CompleteLayerUpload
            Effect: Allow
            Resource:
              Fn::GetAtt:
                - CIV2ECRRepositoryName631C35B1
                - Arn
          - Action:
              - s3:GetObject*
              - s3:GetBucket*
              - s3:List*
              - s3:DeleteObject*
              - s3:PutObject
              - s3:PutObjectLegalHold
              - s3:PutObjectRetention
              - s3:PutObjectTagging
              - s3:PutObjectVersionTagging
              - s3:Abort*
            Effect: Allow
            Resource:
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - ":s3:::"
                    - Ref: S3BucketSourceArtifacts
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - ":s3:::"
                    - Ref: S3BucketSourceArtifacts
                    - /*
        Version: 2012-10-17
      PolicyName: CIV2CIESBuildProjectRoleDefaultPolicy35E296F6
      Roles:
        - Ref: CIV2CIESBuildProjectRole91832A06
    Metadata:
      aws:cdk:path: image-ci/CIAllProduct/CIV2/CIESBuildProject/Role/DefaultPolicy/Resource
  CIV2CIESBuildProjectA5E45E83:
    Type: AWS::CodeBuild::Project
    Properties:
      Artifacts:
        Type: CODEPIPELINE
      Environment:
        ComputeType: BUILD_GENERAL1_SMALL
        EnvironmentVariables:
          - Name: REPOSITORY_URI
            Type: PLAINTEXT
            Value:
              Fn::Join:
                - ""
                - - Fn::Select:
                      - 4
                      - Fn::Split:
                          - ":"
                          - Fn::GetAtt:
                              - CIV2ECRRepositoryName631C35B1
                              - Arn
                  - .dkr.ecr.
                  - Fn::Select:
                      - 3
                      - Fn::Split:
                          - ":"
                          - Fn::GetAtt:
                              - CIV2ECRRepositoryName631C35B1
                              - Arn
                  - .
                  - Ref: AWS::URLSuffix
                  - /
                  - Ref: CIV2ECRRepositoryName631C35B1
          - Name: AWS_DEFAULT_REGION
            Type: PLAINTEXT
            Value:
              Ref: AWS::Region
          - Name: AWS_ACCOUNT_ID
            Type: PLAINTEXT
            Value:
              Ref: AWS::AccountId
          - Name: CONTAINER_PORT
            Type: PLAINTEXT
            Value:
              Ref: ContainerPort
          - Name: BUILD_TYPE
            Type: PLAINTEXT
            Value:
              Ref: PackagingType
          - Name: TARGET_TYPE
            Type: PLAINTEXT
            Value:
              Ref: EnvType
          - Name: SERVICE_NAME
            Type: PLAINTEXT
            Value:
              Ref: ServiceName
        Image: aws/codebuild/amazonlinux2-x86_64-standard:3.0
        ImagePullCredentialsType: CODEBUILD
        PrivilegedMode: true
        Type: LINUX_CONTAINER
      ServiceRole:
        Fn::GetAtt:
          - CIV2CIESBuildProjectRole91832A06
          - Arn
      Source:
        BuildSpec: >-
          {
            "version": 0.2,
            "env": {
              "exported-variables": [
                "IMAGE_TAG"
              ]
            },
            "phases": {
              "pre_build": {
                "commands": [
                  "echo Logging in to Amazon ECR...",
                  "echo $AWS_DEFAULT_REGION",
                  "echo $CODEBUILD_RESOLVED_SOURCE_VERSION",
                  "echo $CODEBUILD_SOURCE_VERSION",
                  "echo $AWS_ACCOUNT_ID",
                  "echo $SERVICE_NAME",
                  "echo $CONTAINER_PORT",
                  "echo $ARTIFACT_BUCKET",
                  "echo $BUILD_TYPE",
                  "echo $TARGET_TYPE",
                  "aws --version",
                  "COMMIT_HASH=$(echo $CODEBUILD_RESOLVED_SOURCE_VERSION | cut -c 1-7)",
                  "IMAGE_TAG=${COMMIT_HASH:=latest}",
                  "export MAVEN_OPTS=\"-Xmx1024m -XX:MaxPermSize=512m\"",
                  "if [ \"$BUILD_TYPE\" = \"DOCKER\" ]; then\n  aws ecr get-login-password --region $AWS_DEFAULT_REGION | docker login --username AWS --password-stdin $(aws sts get-caller-identity --query Account --output text).dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com\nfi\n"
                ]
              },
              "build": {
                "commands": [
                  "export IMAGE_TAG=$COMMIT_HASH",
                  "echo IMAGE_TAG is $IMAGE_TAG",
                  "echo Build started on `date`",
                  "echo $BUILD_TYPE",
                  "if [ \"$BUILD_TYPE\" = \"GRADLE\" ]; then \n  java --version ;\n  chmod +x gradlew ;\n  ./gradlew clean build ;\nfi\n",
                  "if [ \"$BUILD_TYPE\" = \"MAVEN\" ]; then \n  which mvn;\n  chmod +x mvnw ;\n  ./mvnw package;\nfi\n",
                  "if [ \"$BUILD_TYPE\" = \"NPM\" ]; then \n  echo Installing source NPM dependencies...;\n  npm install -y -g --unsafe-perm ;\nfi\n",
                  "if [ \"$BUILD_TYPE\" = \"DOCKER\" ]; then \n  echo Building the Docker image...\n  docker build -t $REPOSITORY_URI:latest .\n\n  echo Tagging Docker image...\n  docker tag $REPOSITORY_URI:latest $REPOSITORY_URI:$IMAGE_TAG\n\n  echo Pushing the Docker images...\n  docker push $REPOSITORY_URI:latest\n  docker push $REPOSITORY_URI:$IMAGE_TAG\nfi\n"
                ]
              },
              "post_build": {
                "commands": [
                  "echo Build completed on `date`",
                  "echo $BUILD_TYPE",
                  "if [ \"$BUILD_TYPE\" = \"GRADLE\" ]; then \n  mv build/libs/*.jar app.jar\n  mv .ebextentions .ebextentions\n  echo Writing Procfile for Beanstlak...\n  zip -r $IMAGE_TAG.zip app.jar .ebextentions\n  aws s3 cp ./$IMAGE_TAG.zip s3://$ARTIFACT_BUCKET/$SERVICE_NAME/$IMAGE_TAG.zip\n  aws s3 cp ./$IMAGE_TAG.zip s3://$ARTIFACT_BUCKET/$SERVICE_NAME/latest.zip\nfi\n",
                  "if [ \"$BUILD_TYPE\" = \"MAVEN\" ]; then \n  mv target/*.jar app.jar\n  mv .ebextentions .ebextentions\n  echo Writing Procfile for Beanstlak...\n  zip -r $IMAGE_TAG.zip app.jar .ebextentions\n  aws s3 cp ./$IMAGE_TAG.zip s3://$ARTIFACT_BUCKET/$SERVICE_NAME/$IMAGE_TAG.zip\n  aws s3 cp ./$IMAGE_TAG.zip s3://$ARTIFACT_BUCKET/$SERVICE_NAME/latest.zip\nfi\n",
                  "if [ \"$BUILD_TYPE\" = \"DOCKER\" ]; then \n  if [ \"$TARGET_TYPE\" = \"ecs\" ]; then \n    echo Writing image definitions file for ECS...\n    printf '[{\"name\": \"%s\", \"imageUri\":\"%s\"}]' $SERVICE_NAME $REPOSITORY_URI:$IMAGE_TAG > imagedefinitions.json\n    zip -r $IMAGE_TAG.zip imagedefinitions.json\n    aws s3 cp ./$IMAGE_TAG.zip s3://$ARTIFACT_BUCKET/$SERVICE_NAME/$IMAGE_TAG.zip\n    aws s3 cp ./$IMAGE_TAG.zip s3://$ARTIFACT_BUCKET/$SERVICE_NAME/latest.zip\n  fi \n\n  if [ \"$TARGET_TYPE\" = \"beanstalk\" ]; then \n    echo Writing Dockerrun.aws.json file for Beanstalk ...\n    printf '{ \"AWSEBDockerrunVersion\":\"1\",\"Image\": {\"Name\": \"%s\"}, \"Ports\":[{\"ContainerPort\": \"%s\"}] }' $REPOSITORY_URI:$IMAGE_TAG $CONTAINER_PORT > Dockerrun.aws.json\n    zip -r $IMAGE_TAG.zip Dockerrun.aws.json\n    aws s3 cp ./$IMAGE_TAG.zip s3://$ARTIFACT_BUCKET/$SERVICE_NAME/$IMAGE_TAG.zip\n    aws s3 cp ./$IMAGE_TAG.zip s3://$ARTIFACT_BUCKET/$SERVICE_NAME/latest.zip\n  fi \n\n  if [ \"$TARGET_TYPE\" = \"EKS\" ]; then \n    echo Writing image definitions file for EKS...\n  fi \n\n  if [ \"$TARGET_TYPE\" = \"LAMBDA\" ]; then \n    echo Writing image definitions file for LAMBDA...\n  fi \nfi\n"
                ]
              }
            },
            "artifacts": {
              "files": [
                "**/*"
              ],
              "name": "$IMAGE_TAG"
            }
          }
        Type: CODEPIPELINE
      Cache:
        Modes:
          - LOCAL_DOCKER_LAYER_CACHE
        Type: LOCAL
      EncryptionKey: alias/aws/s3
    Metadata:
      aws:cdk:path: image-ci/CIAllProduct/CIV2/CIESBuildProject/Resource
  CIV2GitHubRoleA041DDE7:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: codepipeline.amazonaws.com
        Version: 2012-10-17
    Metadata:
      aws:cdk:path: image-ci/CIAllProduct/CIV2/GitHub/Role/Resource
  CIV2GitHubRoleDefaultPolicy05B656D4:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - s3:GetObject*
              - s3:GetBucket*
              - s3:List*
              - s3:DeleteObject*
              - s3:PutObject
              - s3:PutObjectLegalHold
              - s3:PutObjectRetention
              - s3:PutObjectTagging
              - s3:PutObjectVersionTagging
              - s3:Abort*
            Effect: Allow
            Resource:
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - ":s3:::"
                    - Ref: S3BucketSourceArtifacts
              - Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - ":s3:::"
                    - Ref: S3BucketSourceArtifacts
                    - /*
          - Action: sts:AssumeRole
            Effect: Allow
            Resource:
              Fn::GetAtt:
                - CIV2GitHubBUILDBuildCodePipelineActionRole70C5A6E9
                - Arn
        Version: 2012-10-17
      PolicyName: CIV2GitHubRoleDefaultPolicy05B656D4
      Roles:
        - Ref: CIV2GitHubRoleA041DDE7
    Metadata:
      aws:cdk:path: image-ci/CIAllProduct/CIV2/GitHub/Role/DefaultPolicy/Resource
  CIV2GitHub31A12F04:
    Type: AWS::CodePipeline::Pipeline
    Properties:
      RoleArn:
        Fn::GetAtt:
          - CIV2GitHubRoleA041DDE7
          - Arn
      Stages:
        - Actions:
            - ActionTypeId:
                Category: Source
                Owner: ThirdParty
                Provider: GitHub
                Version: "1"
              Configuration:
                Owner:
                  Ref: RepoOwner
                Repo:
                  Ref: RepoName
                Branch:
                  Ref: RepoBranch
                OAuthToken:
                  Fn::Join:
                    - ""
                    - - "{{resolve:secretsmanager:"
                      - Ref: GithubSecretTokenId
                      - :SecretString:::}}
                PollForSourceChanges: false
              Name: GITHUB
              OutputArtifacts:
                - Name: Source
              RunOrder: 1
          Name: SOURCE
        - Actions:
            - ActionTypeId:
                Category: Build
                Owner: AWS
                Provider: CodeBuild
                Version: "1"
              Configuration:
                ProjectName:
                  Ref: CIV2CIESBuildProjectA5E45E83
              InputArtifacts:
                - Name: Source
              Name: Build
              OutputArtifacts:
                - Name: Build
              RoleArn:
                Fn::GetAtt:
                  - CIV2GitHubBUILDBuildCodePipelineActionRole70C5A6E9
                  - Arn
              RunOrder: 1
          Name: BUILD
      ArtifactStore:
        Location:
          Ref: S3BucketSourceArtifacts
        Type: S3
      Name:
        Fn::Join:
          - ""
          - - Ref: ServiceName
            - -pipeline
    DependsOn:
      - CIV2GitHubRoleDefaultPolicy05B656D4
      - CIV2GitHubRoleA041DDE7
    Metadata:
      aws:cdk:path: image-ci/CIAllProduct/CIV2/GitHub/Resource
  CIV2GitHubSOURCEGITHUBWebhookResource4618C790:
    Type: AWS::CodePipeline::Webhook
    Properties:
      Authentication: GITHUB_HMAC
      AuthenticationConfiguration:
        SecretToken:
          Fn::Join:
            - ""
            - - "{{resolve:secretsmanager:"
              - Ref: GithubSecretTokenId
              - :SecretString:::}}
      Filters:
        - JsonPath: $.ref
          MatchEquals: refs/heads/{Branch}
      TargetAction: GITHUB
      TargetPipeline:
        Ref: CIV2GitHub31A12F04
      TargetPipelineVersion: 1
      RegisterWithThirdParty: true
    Metadata:
      aws:cdk:path: image-ci/CIAllProduct/CIV2/GitHub/SOURCE/GITHUB/WebhookResource
  CIV2GitHubBUILDBuildCodePipelineActionRole70C5A6E9:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              AWS:
                Fn::Join:
                  - ""
                  - - "arn:"
                    - Ref: AWS::Partition
                    - ":iam::"
                    - Ref: AWS::AccountId
                    - :root
        Version: 2012-10-17
    Metadata:
      aws:cdk:path: image-ci/CIAllProduct/CIV2/GitHub/BUILD/Build/CodePipelineActionRole/Resource
  CIV2GitHubBUILDBuildCodePipelineActionRoleDefaultPolicy10AF035F:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - codebuild:BatchGetBuilds
              - codebuild:StartBuild
              - codebuild:StopBuild
            Effect: Allow
            Resource:
              Fn::GetAtt:
                - CIV2CIESBuildProjectA5E45E83
                - Arn
        Version: 2012-10-17
      PolicyName: CIV2GitHubBUILDBuildCodePipelineActionRoleDefaultPolicy10AF035F
      Roles:
        - Ref: CIV2GitHubBUILDBuildCodePipelineActionRole70C5A6E9
    Metadata:
      aws:cdk:path: image-ci/CIAllProduct/CIV2/GitHub/BUILD/Build/CodePipelineActionRole/DefaultPolicy/Resource
  CDKMetadata:
    Type: AWS::CDK::Metadata
    Properties:
      Analytics: v2:deflate64:H4sIAAAAAAAA/02Q0U7DMAxFv4X31FBAfMD2A9X2wCNKHQNu07hKnE1TlX+nTSeNp3uvfH1k+RXeW3h5stfUoBsbzz0sa/haEsULI6FV6+UHuiguo57V4mgIIywnmiWxSryZ43d4pGJQHPWZvYOl45k8B1rXB0LdmndbDNtppYinur9pJ56x4nZXTHqDQ8aR9GATVfB8Jz7Ytf/Pf1L/KzKWUgc22omU4haOEhwrS9gvTpIjUjFhxcKQni/tB7TbN4bE3MQclCeC065/lAoaVSkBAAA=
    Metadata:
      aws:cdk:path: image-ci/CIAllProduct/CDKMetadata/Default
    Condition: CDKMetadataAvailable
